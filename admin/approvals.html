<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBU Gym - Member Approvals</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary-color: #51ccf9; --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #212529; }
        body.dark-mode { --bg-body: #121212; --bg-card: #252525; --text-main: #f8f9fa; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: "Inter", sans-serif; }
        
        .navbar { background-color: var(--bg-card); border-bottom: 1px solid #ced4da; }
        .nav-link { color: var(--text-main); }
        .nav-link:hover, .nav-link.active { color: var(--primary-color); }

        .card { background-color: var(--bg-card); border: none; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .table { color: var(--text-main); }
        .table thead th { background-color: rgba(81, 204, 249, 0.1); color: var(--text-main); }
        .profile-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid var(--primary-color); }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="adminPage.html"><span class="highlight" style="color: var(--primary-color);"><i class="fas fa-dumbbell me-2" ></i>DBU</span>-GYM Admin</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="adminPage.html"><i class="fas fa-chart-line me-1"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="#"><i class="fas fa-user-check me-1"></i> Approvals <span class="badge bg-danger rounded-pill" id="pendingCount">0</span></a></li>
                </ul>
                <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4 fw-bold">Pending Registrations</h2>
            <button class="btn btn-outline-primary btn-sm" onclick="fetchPendingMembers()"><i class="fas fa-sync-alt me-1"></i> Refresh</button>
        </div>

        <div class="card p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead><tr><th>Date</th><th>Name</th><th>Type</th><th>ID Number</th><th>Plan</th><th class="text-end">Actions</th></tr></thead>
                    <tbody id="approvalsTableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="emptyState" class="text-center py-5 d-none"><i class="fas fa-check-circle fa-4x text-success mb-3"></i><h5 class="text-muted">All caught up! No pending approvals.</h5></div>
    </main>

    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Review Application</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <img src="" id="reviewImage" class="profile-preview mb-3">
                    <h4 id="reviewName" class="fw-bold mb-1"></h4>
                    <p id="reviewEmail" class="text-muted small mb-3"></p>
                    <div class="card bg-light p-3 text-start mb-3">
                        <div class="row g-2 small">
                            <div class="col-6 text-muted">Membership ID:</div><div class="col-6 fw-bold" id="reviewGymID"></div>
                            <div class="col-6 text-muted">Type:</div><div class="col-6 fw-bold" id="reviewType"></div>
                            <div class="col-6 text-muted">ID/Dept:</div><div class="col-6 fw-bold" id="reviewProofID"></div>
                            <div class="col-6 text-muted">Phone:</div><div class="col-6 fw-bold" id="reviewPhone"></div>
                            <div class="col-6 text-muted">Payment:</div><div class="col-6 fw-bold text-success">Paid</div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-danger w-50" id="btnReject">Reject</button>
                        <button class="btn btn-success w-50" id="btnApprove">Approve</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/users';
        let currentReviewId = null;

        document.addEventListener('DOMContentLoaded', fetchPendingMembers);

        async function fetchPendingMembers() {
            try {
                const res = await fetch(`${API_URL}?membershipStatus=pending`);
                const pendingUsers = await res.json();
                renderTable(pendingUsers);
                document.getElementById('pendingCount').textContent = pendingUsers.length;
            } catch (err) { console.error(err); }
        }

        function renderTable(users) {
            const tbody = document.getElementById('approvalsTableBody');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';
            
            if (users.length === 0) { emptyState.classList.remove('d-none'); return; }
            emptyState.classList.add('d-none');

            users.forEach(user => {
                const proofID = user.isUniversityMember ? user.universityId : user.nationalId;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="small text-muted">${user.joinDate}</td>
                    <td class="fw-bold">${user.fullName}</td>
                    <td><span class="badge ${user.isUniversityMember ? 'bg-info' : 'bg-secondary'}">${user.isUniversityMember ? 'Uni' : 'Ext'}</span></td>
                    <td class="font-monospace small">${proofID || 'N/A'}</td>
                    <td>${user.membershipType}</td>
                    <td class="text-end"><button class="btn btn-sm btn-primary px-3" onclick='openReview(${JSON.stringify(user)})'>Review</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        window.openReview = (user) => {
            currentReviewId = user.id;
            document.getElementById('reviewImage').src = user.profileImage;
            document.getElementById('reviewName').textContent = user.fullName;
            document.getElementById('reviewEmail').textContent = user.email;
            document.getElementById('reviewGymID').textContent = user.membershipId;
            document.getElementById('reviewType').textContent = user.isUniversityMember ? 'University Student' : 'External Member';
            document.getElementById('reviewProofID').textContent = user.isUniversityMember ? user.universityId : (user.nationalId || 'N/A');
            document.getElementById('reviewPhone').textContent = user.phone;
            new bootstrap.Modal(document.getElementById('reviewModal')).show();
        };

        document.getElementById('btnApprove').addEventListener('click', async () => {
            if(!currentReviewId) return;
            try {
                await fetch(`${API_URL}/${currentReviewId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ membershipStatus: 'active' }) });
                alert("Member Approved!"); location.reload();
            } catch(e) { alert("Error approving member."); }
        });

        document.getElementById('btnReject').addEventListener('click', async () => {
            if(!currentReviewId) return;
            if(!confirm("Reject this application?")) return;
            try {
                await fetch(`${API_URL}/${currentReviewId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ membershipStatus: 'rejected' }) });
                alert("Application Rejected."); location.reload();
            } catch(e) { alert("Error rejecting member."); }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.removeItem('currentUser'); window.location.href = '../login/login.html'; });
    </script>
</body>
</html>