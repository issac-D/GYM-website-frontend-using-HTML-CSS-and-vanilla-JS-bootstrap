<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBU Gym - Member Registration</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

     <style>
        :root {
            --primary-color: #51CCF9;
            --primary-dark: #3db0da; 
            --bg-body: #f8f9fa; /* Light mode background */
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --input-bg: #fff;
            --input-border: #ced4da;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }

        /* Dark Theme Overrides */
        body.dark-mode {
            --bg-body: #121212;
            --bg-card: #252525;
            --text-main: #f8f9fa;
            --text-muted: #adb5bd;
            --input-bg: #2b2b2b;
            --input-border: #444;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* Global Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        .highlight {
            color: var(--primary-color);
        }

        /* Container and Card Styling */
        .registration-container {
            max-width: 800px;
            margin-top: 50px;
            margin-bottom: 50px;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            box-shadow: 0 10px 25px var(--shadow-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Form Control Overrides (Inputs) */
        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-main);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(81, 204, 249, 0.5); 
            background-color: var(--input-bg);
            color: var(--text-main);
        }
        
        /* Member Type Toggle */
        .member-type-toggle .btn {
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .member-type-toggle .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .member-type-toggle .btn-outline-primary.active {
            background-color: var(--primary-color);
            color: #000;
            box-shadow: 0 4px 8px rgba(81, 204, 249, 0.3);
        }

        /* Submit Button Styling */
        .btn-submit {
            background-color: var(--primary-color);
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(81, 204, 249, 0.4);
            color: #000;
        }
        
        /* Theme Toggle Button */
        #theme-toggle {
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 1.2rem;
            padding: 5px;
            transition: color 0.3s;
        }
        #theme-toggle:hover {
            color: var(--primary-color);
        }

        /* Auto-Generated ID Display */
        #gymIdDisplay {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.1rem;
            background-color: var(--bg-alt, #f9f9f9);
            padding: 8px;
            border-radius: 6px;
            color: #333;
        }
     </style>
</head>
<body class="d-flex justify-content-center">

    <div class="registration-container container">
        
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 fw-bold text-center"><span class="highlight"><i class="fas fa-dumbbell me-2"></i>DBU-</span>GYM Registration</h1>
            <button id="theme-toggle" aria-label="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <div class="card p-4 p-md-5">
            <h2 class="h5 fw-bold mb-3">Member Type Selection</h2>
            
            <div class="member-type-toggle mb-4 d-flex gap-3">
                <button type="button" class="btn btn-outline-primary active" id="type-uni-btn" data-type="university">
                    <i class="fas fa-university me-2"></i> University Member
                </button>
                <button type="button" class="btn btn-outline-primary" id="type-ext-btn" data-type="external">
                    <i class="fas fa-user-friends me-2"></i> External Member
                </button>
            </div>
            
            <div class="mb-4 p-3 bg-light rounded" id="gymIdContainer">
                <label class="form-label mb-1"  style="color: var(--text-muted);">Generated Gym Member ID</label>
                <div id="gymIdDisplay">Fetching...</div>
            </div>

            <form id="registrationForm" novalidate>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="fullName" class="form-label fw-semibold"  style="color: var(--text-main);">Full Name<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fullName" required>
                        <div class="invalid-feedback">Full Name is required.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label fw-semibold" style="color: var(--text-main);">Email<span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" required>
                        <div class="invalid-feedback">A valid Email is required.</div>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="password" class="form-label fw-semibold" style="color: var(--text-main);">Password<span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="password" required>
                        <div class="invalid-feedback">Password is required.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="phoneNumber" class="form-label fw-semibold" style="color: var(--text-main);">Phone Number<span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="phoneNumber" placeholder="+251..." required>
                        <div class="invalid-feedback">Phone Number is required.</div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label for="profileImage" class="form-label fw-semibold" style="color: var(--text-main);">Profile Picture</label>
                        <input type="file" class="form-control" id="profileImage" accept="image/*">
                        <div class="form-text " style="color: var(--text-muted);">Upload a photo (Max 1MB).</div>
                    </div>
                    <div class="col-md-6">
                        <label for="gender" class="form-label fw-semibold" style="color: var(--text-main);">Gender<span class="text-danger">*</span></label>
                        <select class="form-select" id="gender" required>
                            <option value="" disabled selected>Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <label for="membershipType" class="form-label fw-semibold" style="color: var(--text-main);">Membership Plan<span class="text-danger">*</span></label>
                        <select class="form-select" id="membershipType" required>
                            <option value="" disabled selected>Select Plan Duration</option>
                            <option value="Monthly">Monthly</option>
                            <option value="3Months">3 Months</option>
                            <option value="6Months">6 Months</option>
                            <option value="1Year">1 Year</option>
                        </select>
                        <div class="invalid-feedback">Membership Type is required.</div>
                    </div>
                </div>

                <div id="uniFields">
                    <h5 class="fw-bold mb-3 text-secondary">University Details</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="uniID" class="form-label fw-semibold" style="color: var(--text-main);">University ID<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="uniID" required>
                            <div class="invalid-feedback">University ID is required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="department" class="form-label fw-semibold" style="color: var(--text-main);">Department/College<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="department" required>
                            <div class="invalid-feedback">Department is required.</div>
                        </div>
                    </div>
                </div>

                <div id="extFields" class="d-none">
                    <h5 class="fw-bold mb-3 text-secondary">External Member Details</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="nationalID" class="form-label fw-semibold" style="color: var(--text-main);">National ID / Passport<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nationalID">
                            <div class="invalid-feedback">National ID or Passport is required.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="address" class="form-label fw-semibold" style="color: var(--text-main);">Address<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="address">
                            <div class="invalid-feedback">Address is required.</div>
                        </div>
                    </div>
                </div>
                
                <hr class="mb-4">

                <button type="submit" class="btn btn-submit w-100"><i class="fas fa-user-plus me-2"></i> Register Member</button>

            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            const icon = themeToggle.querySelector('i');
            const form = document.getElementById('registrationForm');
            const uniFields = document.getElementById('uniFields');
            const extFields = document.getElementById('extFields');
            const typeUniBtn = document.getElementById('type-uni-btn');
            const typeExtBtn = document.getElementById('type-ext-btn');
            const gymIdDisplay = document.getElementById('gymIdDisplay');
            
            let currentMemberType = 'university';
            let nextIdCounter = 1;

            // --- 1. Fetch Current User Count (For ID Generation) ---
            try {
                const res = await fetch('http://localhost:3000/users');
                const users = await res.json();
                nextIdCounter = users.length + 1;
                updateGymIdDisplay();
            } catch (err) {
                console.error("Failed to connect to JSON Server:", err);
                gymIdDisplay.textContent = "Error: Start JSON Server";
            }

            // --- 2. Theme Setup ---
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.classList.add('dark-mode');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }

            themeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                if (body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    localStorage.setItem('theme', 'dark');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    localStorage.setItem('theme', 'light');
                }
            });

            // --- 3. Gym ID Generation Logic ---
            function updateGymIdDisplay() {
                const prefix = currentMemberType === 'university' ? 'DBU' : 'EXT';
                const year = new Date().getFullYear();
                const counter = String(nextIdCounter).padStart(4, '0');
                gymIdDisplay.textContent = `${prefix}-${year}-${counter}`;
            }

            // --- 4. Dynamic Field Toggling ---
            function toggleMemberType(type) {
                currentMemberType = type;
                typeUniBtn.classList.toggle('active', type === 'university');
                typeExtBtn.classList.toggle('active', type === 'external');
                uniFields.classList.toggle('d-none', type === 'external');
                extFields.classList.toggle('d-none', type === 'university');

                updateGymIdDisplay();

                document.getElementById('uniID').required = (type === 'university');
                document.getElementById('department').required = (type === 'university');
                document.getElementById('nationalID').required = (type === 'external');
                document.getElementById('address').required = (type === 'external');
            }

            typeUniBtn.addEventListener('click', () => toggleMemberType('university'));
            typeExtBtn.addEventListener('click', () => toggleMemberType('external'));

            // --- 5. Helper: Convert Image to Base64 ---
            const convertToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = (error) => reject(error);
                });
            };

            // --- 6. Helper: Calculate Expiry Date ---
            const calculateExpiry = (planType) => {
                const date = new Date();
                if (planType === 'Monthly') date.setMonth(date.getMonth() + 1);
                else if (planType === '3Months') date.setMonth(date.getMonth() + 3);
                else if (planType === '6Months') date.setMonth(date.getMonth() + 6);
                else if (planType === '1Year') date.setFullYear(date.getFullYear() + 1);
                return date.toISOString().split('T')[0]; // Format YYYY-MM-DD
            };

            // --- 7. Form Submission ---
            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                e.stopPropagation();

                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }

                // Handle Image Upload
                const fileInput = document.getElementById('profileImage');
                let base64Image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+P+/HgAFhAJ/wlseKgAAAABJRU5ErkJggg=="; // Default placeholder
                
                if (fileInput.files.length > 0) {
                    try {
                        base64Image = await convertToBase64(fileInput.files[0]);
                    } catch (err) {
                        console.error("Image conversion failed", err);
                        alert("Failed to upload image.");
                        return;
                    }
                }

                // Construct User Object
                const today = new Date().toISOString().split('T')[0];
                const planType = document.getElementById('membershipType').value;
                const membershipId = gymIdDisplay.textContent;

                const newUser = {
                    role: "user",
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phoneNumber').value,
                    password: document.getElementById('password').value,
                    gender: document.getElementById('gender').value,
                    profileImage: base64Image,
                    
                    isUniversityMember: (currentMemberType === 'university'),
                    universityId: currentMemberType === 'university' ? document.getElementById('uniID').value : null,
                    department: currentMemberType === 'university' ? document.getElementById('department').value : null,
                    
                    nationalId: currentMemberType === 'external' ? document.getElementById('nationalID').value : null,
                    address: currentMemberType === 'external' ? document.getElementById('address').value : null,
                    
                    membershipId: membershipId,
                    discountPercentage: (currentMemberType === 'university' ? 20 : 0),
                    membershipType: planType,
                    membershipStatus: "active",
                    joinDate: today,
                    expiryDate: calculateExpiry(planType),
                    paymentStatus: "Paid" 
                };

                // Send POST Request
                try {
                    const response = await fetch('http://localhost:3000/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newUser)
                    });

                    if (response.ok) {
                        alert(`Success! Member registered with ID: ${membershipId}. Redirecting to Login...`);
                        window.location.href = '../login/login.html';
                    } else {
                        throw new Error('Server responded with error');
                    }
                } catch (error) {
                    console.error("Registration failed:", error);
                    alert("Registration failed. Ensure JSON Server is running.");
                }
            });
        });
    </script>
</body>
</html>